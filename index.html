<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0d1117">
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GitMobile">
    <link rel="icon" type="image/webp" href="https://files.catbox.moe/6kd6rm.webp">
    <link rel="apple-touch-icon" href="https://files.catbox.moe/6kd6rm.webp">

    <title>GitMobile v8</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --bg-body: #0d1117;
            --bg-panel: #161b22;
            --bg-hover: #21262d;
            --border: #30363d;
            --primary: #238636;
            --danger: #da3633;
            --text-main: #e6edf3;
            --text-muted: #8b949e;
            --header-h: 60px;
            --radius: 8px;
        }

        /* --- RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; user-select: none; }
        input, textarea, .selectable { user-select: text; }

        /* --- ICONS --- */
        .icon { font-family: 'Material Symbols Outlined'; font-weight: normal; font-style: normal; font-size: 24px; line-height: 1; letter-spacing: normal; text-transform: none; display: inline-block; white-space: nowrap; word-wrap: normal; direction: ltr; }
        .icon-sm { font-size: 20px; }
        .icon-lg { font-size: 48px; }

        /* --- UI COMPONENTS --- */
        .btn {
            background: var(--bg-hover); border: 1px solid var(--border); color: var(--text-main);
            padding: 10px 16px; border-radius: var(--radius); font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s; font-size: 14px;
        }
        .btn:active { transform: scale(0.96); background: #30363d; }
        .btn:disabled { opacity: 0.5; pointer-events: none; }
        .btn-primary { background: var(--primary); border-color: rgba(255,255,255,0.1); color: white; }
        .btn-danger { background: rgba(218,54,51,0.1); color: #f85149; border-color: rgba(218,54,51,0.4); }
        .btn-icon { width: 44px; height: 44px; padding: 0; border-radius: 50%; }

        input, select { background: var(--bg-body); border: 1px solid var(--border); color: white; padding: 12px; border-radius: var(--radius); width: 100%; font-size: 16px; }
        
        /* --- LAYOUT --- */
        .view { position: absolute; inset: 0; background: var(--bg-body); display: flex; flex-direction: column; opacity: 0; pointer-events: none; padding-bottom: env(safe-area-inset-bottom); }
        .view.active { opacity: 1; pointer-events: all; z-index: 10; }
        
        header { 
            height: calc(var(--header-h) + env(safe-area-inset-top)); 
            padding-top: env(safe-area-inset-top); 
            background: var(--bg-panel); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; 
            padding-left: 16px; padding-right: 16px; flex-shrink: 0; 
        }
        .scroll-area { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 16px; }

        /* --- LISTS --- */
        .list-item { 
            background: var(--bg-panel); border: 1px solid var(--border); 
            padding: 14px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; 
            /* Sharp corners for items generally, but maybe slight radius looks better with Material icons */
            border-radius: 2px; 
        }
        .list-item:active { background: var(--bg-hover); }
        .list-item.selected { border-color: var(--primary); background: rgba(35,134,54,0.15); }
        
        /* --- EDITOR --- */
        .editor-wrapper { flex: 1; display: flex; background: #0d1117; font-family: 'JetBrains Mono', monospace; font-size: 13px; overflow: hidden; }
        .gutter { width: 40px; background: #0d1117; border-right: 1px solid var(--border); color: #484f58; text-align: right; padding: 10px 5px; line-height: 20px; }
        .code-area { flex: 1; background: transparent; color: #e6edf3; border: none; padding: 10px; resize: none; white-space: pre; overflow: auto; tab-size: 2; line-height: 20px; }

        /* --- MODALS (Bottom Sheet Style) --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; 
            display: none; align-items: flex-end; /* Bottom alignment */
            justify-content: center; backdrop-filter: blur(2px);
        }
        .modal-overlay.open { display: flex; }
        
        .modal-sheet { 
            background: var(--bg-panel); border-top: 1px solid var(--border); 
            width: 100%; max-width: 600px; 
            border-top-left-radius: 16px; border-top-right-radius: 16px; 
            padding: 24px; max-height: 85vh; display: flex; flex-direction: column;
            transform: translateY(100%); 
        }

        /* --- MOVE DIALOG SPECIFIC --- */
        .folder-list { overflow-y: auto; margin: 16px 0; border: 1px solid var(--border); border-radius: 8px; max-height: 300px; }
        .folder-row { 
            padding: 12px 16px; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; gap: 12px; cursor: pointer;
            transition: background 0.2s;
        }
        .folder-row:last-child { border-bottom: none; }
        .folder-row.active { background: var(--primary); color: white; }
        .folder-row .radio-circle {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-muted);
            display: flex; align-items: center; justify-content: center;
        }
        .folder-row.active .radio-circle { border-color: white; background: white; }
        .folder-row.active .radio-circle::after { content:''; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }

        /* --- TOAST & UTILS --- */
        #toast-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 6000; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: var(--bg-panel); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        .loader { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        .btn.loading .loader { display: block; } .btn.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- VIEW 1: LOGIN -->
    <div id="view-login" class="view active">
        <div style="margin: auto; width: 100%; max-width: 320px; text-align: center;">
            <span class="icon icon-lg" style="margin-bottom: 20px;">deployed_code</span>
            <h1 style="margin: 0 0 32px 0;">GitMobile</h1>
            <input type="password" id="input-token" placeholder="Personal Access Token" style="margin-bottom: 20px;">
            <button class="btn btn-primary w-full" id="btn-login" style="padding: 14px;">
                <div class="loader"></div><span>Sign In</span>
            </button>
        </div>
    </div>

    <!-- VIEW 2: DASHBOARD -->
    <div id="view-dashboard" class="view">
        <header>
            <div style="display:flex; gap:10px; align-items:center;">
                <img id="user-avatar" src="" style="width:32px; height:32px; border-radius:50%; background:#333;">
                <div id="user-login" style="font-weight:600; font-size:14px;">...</div>
            </div>
            <button class="btn btn-icon" onclick="App.logout()"><span class="icon">logout</span></button>
        </header>
        <div class="scroll-area">
            <div style="display:flex; gap:10px; margin-bottom:16px;">
                <div style="position:relative; flex:1;">
                    <span class="icon" style="position:absolute; left:10px; top:12px; color:#777; font-size:20px;">search</span>
                    <input id="search-input" placeholder="Search..." style="padding-left:36px;">
                </div>
                <select id="search-scope" style="width:auto;"><option value="my">My Repos</option><option value="global">Global</option></select>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="font-size:12px; color:var(--text-muted); font-weight:700;">REPOSITORIES</h3>
                <button class="btn btn-primary" onclick="Modal.open('create')"><span class="icon icon-sm">add</span> New</button>
            </div>
            <div id="repo-list"></div>
        </div>
    </div>

    <!-- VIEW 3: REPO -->
    <div id="view-repo" class="view">
        <header>
            <button class="btn btn-icon" onclick="Nav.to('dashboard')"><span class="icon">arrow_back</span></button>
            <div style="text-align:center; overflow:hidden;">
                <div id="repo-name" style="font-weight:700; white-space:nowrap;">...</div>
                <div id="repo-branch" style="font-size:11px; color:var(--text-muted); font-family:monospace;">main</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-icon" id="btn-select-mode" onclick="Repo.toggleSelect()"><span class="icon">checklist</span></button>
                <button class="btn btn-icon btn-danger" onclick="Repo.deleteRepo()"><span class="icon">delete</span></button>
            </div>
        </header>
        
        <div style="display:flex; background:var(--bg-panel); border-bottom:1px solid var(--border);">
            <button class="btn" style="flex:1; border:none; background:transparent; border-radius:0;" onclick="Repo.tab('files')" id="tab-files">Files</button>
            <button class="btn" style="flex:1; border:none; background:transparent; border-radius:0;" onclick="Repo.tab('upload')" id="tab-upload">Upload</button>
        </div>

        <div id="content-files" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <div style="padding:12px; border-bottom:1px solid var(--border); display:flex; gap:10px;">
                <button class="btn" style="font-size:12px; padding:6px 12px;" onclick="Modal.open('newfile')"><span class="icon icon-sm">description</span> File</button>
                <button class="btn" style="font-size:12px; padding:6px 12px;" onclick="Modal.open('newfolder')"><span class="icon icon-sm">create_new_folder</span> Folder</button>
            </div>
            <div style="display:flex; padding:12px; gap:4px; overflow-x:auto; border-bottom:1px solid var(--border); font-family:monospace; font-size:13px;" id="breadcrumbs"></div>
            <div id="file-list" class="scroll-area" style="padding:0;"></div>
            
            <!-- Selection Bar -->
            <div id="action-bar" style="background:var(--bg-panel); padding:16px; border-top:1px solid var(--border); display:none; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold;"><span id="sel-count">0</span> Selected</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn" onclick="Repo.movePrompt()"><span class="icon icon-sm">drive_file_move</span> Move</button>
                    <button class="btn btn-danger" onclick="Repo.deleteSel()"><span class="icon icon-sm">delete</span></button>
                </div>
            </div>
        </div>

        <div id="content-upload" class="scroll-area hidden">
            <div style="border:2px dashed var(--border); padding:40px; text-align:center; border-radius:8px; margin-top:20px;" onclick="$('file-input').click()">
                <span class="icon icon-lg" style="color:var(--text-muted)">cloud_upload</span>
                <h3>Select Folder</h3>
                <p class="text-muted text-sm">Target: <span id="upload-path">/</span></p>
                <input type="file" id="file-input" multiple webkitdirectory hidden>
            </div>
            <div id="upload-q" class="hidden" style="margin-top:20px;">
                <p>Queue: <span id="q-count">0</span> files</p>
                <input id="up-msg" placeholder="Commit message" value="Bulk upload" style="margin:10px 0;">
                <button class="btn btn-primary w-full" onclick="Repo.upload()">
                    <div class="loader"></div> <span>Start Upload</span>
                </button>
                <div id="up-log" style="font-family:monospace; font-size:11px; margin-top:10px; color:var(--text-muted);"></div>
            </div>
        </div>
    </div>

    <!-- VIEW: EDITOR -->
    <div id="view-editor" class="view" style="z-index:50;">
        <header>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn btn-icon" onclick="Nav.to('repo')"><span class="icon">close</span></button>
                <span id="ed-name" style="font-family:monospace; font-weight:bold;">file.js</span>
            </div>
            <button class="btn btn-primary" onclick="Editor.save()"><div class="loader"></div> <span>Save</span></button>
        </header>
        <div style="padding:10px; background:var(--bg-panel); border-bottom:1px solid var(--border);">
            <input id="ed-msg" placeholder="Commit message">
        </div>
        <div class="editor-wrapper">
            <div class="gutter" id="ed-gutter">1</div>
            <textarea class="code-area" id="ed-code" spellcheck="false" wrap="off"></textarea>
        </div>
    </div>

    <!-- MODAL (BOTTOM SHEET) -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-sheet" id="modal-sheet">
            <h3 id="modal-title" style="margin-top:0;">Title</h3>
            <div id="modal-body" style="flex:1; overflow:hidden; display:flex; flex-direction:column;"></div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn" onclick="Modal.close()">Cancel</button>
                <button class="btn btn-primary" id="modal-ok">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. SAFETY BOOT ---
        window.onerror = (msg) => { alert("Error: " + msg); };

        const $ = id => document.getElementById(id);
        const State = { token: localStorage.getItem('gm8_t'), user: null, repos: [], curr: null, tree: [], path: '', sel: [], selMode: false, files: [], target: null };
        const API = 'https://api.github.com';

        // --- 1. UTILS & GSAP ---
        const Toast = (m, t='s') => {
            const el=document.createElement('div'); el.className='toast';
            el.style.borderLeft=`4px solid ${t==='e'?'var(--danger)':'var(--primary)'}`;
            el.innerHTML=`<span class="icon icon-sm">${t==='e'?'warning':'check'}</span><span>${m}</span>`;
            $('toast-container').appendChild(el);
            gsap.fromTo(el,{opacity:0,y:20},{opacity:1,y:0,duration:0.3});
            setTimeout(()=>{gsap.to(el,{opacity:0,y:10,onComplete:()=>el.remove()})},3000);
        };

        const Loader={on:id=>$(id).classList.add('loading'),off:id=>$(id).classList.remove('loading')};

        const Nav = {
            to: (id) => {
                const old = document.querySelector('.view.active');
                const next = $(`view-${id}`);
                if(old === next) return;
                
                // GSAP Transition
                if(old) gsap.to(old, {opacity:0, scale:0.95, duration:0.2, onComplete:()=>old.classList.remove('active')});
                
                next.classList.add('active');
                gsap.fromTo(next, {opacity:0, scale:1.05}, {opacity:1, scale:1, duration:0.3, delay:0.1});
            }
        };

        const api = async (ep, opt={}) => {
            try {
                const url = ep.startsWith('http')?ep:`${API}${ep}`;
                const r = await fetch(url, {...opt, headers: {'Authorization':`token ${State.token}`, 'Accept':'application/vnd.github.v3+json', ...opt.headers}});
                if(r.status===204) return null;
                const d = await r.json();
                if(!r.ok) throw new Error(d.message);
                return d;
            } catch(e) { Toast(e.message, 'e'); throw e; }
        };

        // --- 2. MODAL SYSTEM ---
        const Modal = {
            el: $('modal-overlay'),
            sheet: $('modal-sheet'),
            open: (t, body, fn) => {
                $('modal-title').textContent=t; $('modal-body').innerHTML=body;
                $('modal-ok').onclick = fn; 
                Modal.el.classList.add('open');
                gsap.fromTo(Modal.sheet, {y:'100%'}, {y:'0%', duration:0.3, ease:'power2.out'});

                if(t==='create') { $('modal-body').innerHTML='<input id="new-repo" placeholder="Name" style="margin-top:10px">'; $('modal-ok').textContent='Create'; $('modal-ok').onclick=Repo.create; }
                if(t==='newfile') { $('modal-body').innerHTML=`<p class="text-muted text-xs">In: /${State.path}</p><input id="new-name" placeholder="Name">`; $('modal-ok').textContent='Create'; $('modal-ok').onclick=Editor.new; }
                if(t==='newfolder') { $('modal-body').innerHTML=`<p class="text-muted text-xs">In: /${State.path}</p><input id="new-fname" placeholder="Name">`; $('modal-ok').textContent='Create'; $('modal-ok').onclick=Repo.newFolder; }
                if(t==='move') {
                    // Mobile Friendly Folder Browser
                    const dirs = ['root', ...State.tree.filter(x=>x.type==='tree').map(x=>x.path)];
                    let html = `<div class="folder-list">`;
                    dirs.forEach(d => {
                        const name = d==='root'?'/ (Root)':d.split('/').pop();
                        const depth = d==='root'?0:d.split('/').length;
                        html += `
                        <div class="folder-row" onclick="Modal.selectFolder(this, '${d}')" style="padding-left:${depth*15+16}px">
                            <div class="radio-circle"></div>
                            <span class="icon icon-sm" style="color:var(--text-muted)">folder</span>
                            <span>${name}</span>
                        </div>`;
                    });
                    html += `</div>`;
                    $('modal-body').innerHTML=html;
                    $('modal-ok').textContent='Move Here';
                    $('modal-ok').disabled = true; // Disable until selection
                    $('modal-ok').onclick = Repo.doMove;
                    State.target = null;
                }
            },
            selectFolder: (el, path) => {
                document.querySelectorAll('.folder-row').forEach(e => e.classList.remove('active'));
                el.classList.add('active');
                State.target = path === 'root' ? '' : path;
                $('modal-ok').disabled = false;
            },
            close: () => {
                gsap.to(Modal.sheet, {y:'100%', duration:0.2, onComplete:()=>Modal.el.classList.remove('open')});
            }
        };

        // --- 3. APP LOGIC ---
        const App = {
            init: async () => {
                if(State.token) {
                    Loader.on('btn-login');
                    try {
                        State.user = await api('/user');
                        $('user-login').textContent = State.user.login; $('user-avatar').src = State.user.avatar_url;
                        Nav.to('dashboard'); Repo.list();
                    } catch(e) { localStorage.removeItem('gm8_t'); State.token=null; Nav.to('login'); }
                    finally { Loader.off('btn-login'); }
                } else { Nav.to('login'); }
            },
            login: async () => {
                const t = $('input-token').value.trim(); if(!t) return;
                State.token = t; Loader.on('btn-login');
                try {
                    State.user = await api('/user');
                    localStorage.setItem('gm8_t', t);
                    $('user-login').textContent = State.user.login; $('user-avatar').src = State.user.avatar_url;
                    Nav.to('dashboard'); Repo.list();
                } catch(e) { State.token = null; } finally { Loader.off('btn-login'); }
            },
            logout: () => { localStorage.clear(); location.reload(); }
        };

        const Repo = {
            list: async () => {
                const q=$('search-input').value, s=$('search-scope').value;
                const el=$('repo-list'); el.innerHTML='<div style="padding:20px;text-align:center">Loading...</div>';
                try {
                    let d = [];
                    if(s==='my') {
                        if(State.repos.length===0) State.repos = await api('/user/repos?sort=updated&per_page=50');
                        d = State.repos.filter(x=>x.name.includes(q));
                    } else {
                        if(q.length<3) return el.innerHTML='<div style="padding:20px;text-align:center">Type 3+ chars</div>';
                        const r = await api(`/search/repositories?q=${q}`); d=r.items;
                    }
                    el.innerHTML = d.map(r => `
                        <div class="list-item" onclick="Repo.open('${r.full_name}', '${r.default_branch}')">
                            <div>
                                <div style="color:#58a6ff;font-weight:600">${r.full_name}</div>
                                <div class="text-muted text-xs">${r.description||''}</div>
                            </div>
                            <span class="icon icon-sm" style="color:var(--text-muted)">chevron_right</span>
                        </div>
                    `).join('');
                    
                    // GSAP Stagger
                    gsap.from(".list-item", {opacity:0, y:20, duration:0.3, stagger:0.05});
                    
                } catch(e) { el.innerHTML='Error'; }
            },
            create: async () => {
                const n=$('new-repo').value; if(!n) return;
                await api('/user/repos', {method:'POST', body:JSON.stringify({name:n, private:true, auto_init:true})});
                Modal.close(); State.repos=[]; Repo.list();
            },
            open: (n, b) => {
                State.curr = {full_name:n, default_branch:b}; $('repo-name').textContent=n; $('repo-branch').textContent=b;
                Nav.to('repo'); Repo.path=''; Repo.fetch();
            },
            fetch: async () => {
                const el=$('file-list'); el.innerHTML='<div style="padding:20px">Loading...</div>';
                try {
                    const r = await api(`/repos/${State.curr.full_name}/git/trees/${State.curr.default_branch}?recursive=1`);
                    State.tree = r.tree; Repo.render();
                } catch(e) { el.innerHTML='Empty'; State.tree=[]; Repo.render(); }
            },
            render: () => {
                const el=$('file-list'); el.innerHTML='';
                const p = State.path;
                
                // Breadcrumbs
                const bc=$('breadcrumbs'); bc.innerHTML=`<span class="crumb" onclick="Repo.nav('')">root</span>`;
                if(p) p.split('/').forEach((part,i,a) => bc.innerHTML+=`<span>/</span><span class="crumb" onclick="Repo.nav('${a.slice(0,i+1).join('/')}')">${part}</span>`);
                $('upload-path').textContent = p ? '/'+p : '/';

                const items = State.tree.filter(i => {
                    if(p==='') return !i.path.includes('/');
                    return i.path.startsWith(p+'/') && i.path.split('/').length === p.split('/').length+1;
                }).sort((a,b) => (a.type===b.type)?0:(a.type==='tree'?-1:1));

                if(items.length===0) el.innerHTML='<div style="padding:20px;color:var(--text-muted)">Empty</div>';

                items.forEach(i => {
                    const row = document.createElement('div');
                    row.className = `list-item ${State.sel.includes(i.path)?'selected':''}`;
                    const icon = i.type==='tree'?'folder':'description'; const col=i.type==='tree'?'#58a6ff':'#7d8590';
                    
                    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
                        <div style="width:18px;height:18px;border:2px solid #555;border-radius:2px;display:${State.selMode?'flex':'none'};align-items:center;justify-content:center;background:${State.sel.includes(i.path)?'var(--primary)':'transparent'}">${State.sel.includes(i.path)?'<span class="icon" style="font-size:14px;color:white;font-weight:bold">check</span>':''}</div>
                        <span class="icon icon-sm" style="color:${col}">${icon}</span>
                        <span style="font-family:monospace;font-size:13px">${i.path.split('/').pop()}</span>
                    </div>`;
                    
                    row.onclick = () => {
                        if(State.selMode) {
                            if(State.sel.includes(i.path)) State.sel=State.sel.filter(x=>x!==i.path); else State.sel.push(i.path);
                            Repo.updBar(); Repo.render();
                        } else {
                            if(i.type==='tree') Repo.nav(i.path); else Editor.open(i);
                        }
                    };
                    el.appendChild(row);
                });
            },
            nav: p => { State.path = p; Repo.render(); },
            toggleSelect: () => { State.selMode=!State.selMode; State.sel=[]; Repo.updBar(); Repo.render(); },
            updBar: () => { 
                $('sel-count').textContent=State.sel.length; 
                const bar = $('action-bar');
                bar.style.display = (State.selMode && State.sel.length>0) ? 'flex' : 'none';
                if(State.selMode && State.sel.length>0) gsap.fromTo(bar, {y:50, opacity:0}, {y:0, opacity:1, duration:0.2});
            },
            newFolder: async () => {
                const n=$('new-fname').value; if(!n)return; Modal.close();
                const p = (State.path?State.path+'/':'')+n+'/.keep';
                await api(`/repos/${State.curr.full_name}/contents/${p}`, {method:'PUT', body:JSON.stringify({message:'new folder', content:'', branch:State.curr.default_branch})});
                Repo.fetch();
            },
            tab: (t) => {
                $('content-files').classList.toggle('hidden', t!=='files');
                $('content-upload').classList.toggle('hidden', t!=='upload');
                $('tab-files').style.borderBottom = t==='files'?'2px solid #238636':'none';
                $('tab-upload').style.borderBottom = t==='upload'?'2px solid #238636':'none';
            },
            upload: async () => {
                if(State.files.length===0) return; 
                const log=$('up-log'); log.innerHTML='Uploading...';
                try {
                    for(let f of State.files) {
                        const p = (State.path?State.path+'/':'') + f.webkitRelativePath.split('/').slice(1).join('/');
                        log.innerHTML+=`<br>${p}`;
                        const reader = new FileReader();
                        const b64 = await new Promise(r=>{reader.onload=()=>r(reader.result.split(',')[1]);reader.readAsDataURL(f)});
                        let sha; try{const e=await api(`/repos/${State.curr.full_name}/contents/${p}`);sha=e.sha}catch(z){}
                        await api(`/repos/${State.curr.full_name}/contents/${p}`,{method:'PUT',body:JSON.stringify({message:$('up-msg').value,content:b64,sha,branch:State.curr.default_branch})});
                    }
                    Toast('Done'); $('up-msg').value=''; Repo.tab('files'); Repo.fetch();
                } catch(e){ log.innerHTML+=' ERROR'; }
            },
            deleteSel: async () => {
                if(!confirm('Delete selected?'))return;
                for(let p of State.sel) {
                    const i = State.tree.find(x=>x.path===p);
                    if(i.type==='blob') await api(`/repos/${State.curr.full_name}/contents/${p}`,{method:'DELETE',body:JSON.stringify({message:`del ${p}`,sha:i.sha,branch:State.curr.default_branch})});
                }
                Toast('Deleted'); Repo.toggleSelect(); Repo.fetch();
            },
            deleteRepo: async () => { if(confirm('DELETE REPO?')) { await api(`/repos/${State.curr.full_name}`,{method:'DELETE'}); Nav.to('dashboard'); Repo.list(); } },
            movePrompt: () => Modal.open('move'),
            doMove: async () => {
                const t = State.target; Modal.close(); Toast('Moving...');
                for(let src of State.sel) {
                    const n = src.split('/').pop(); const dest = t?`${t}/${n}`:n; if(src===dest)continue;
                    const item = State.tree.find(x=>x.path===src);
                    if(item.type==='blob') {
                        const d = await api(`/repos/${State.curr.full_name}/contents/${src}`);
                        await api(`/repos/${State.curr.full_name}/contents/${dest}`,{method:'PUT',body:JSON.stringify({message:`mv`,content:d.content,branch:State.curr.default_branch})});
                        await api(`/repos/${State.curr.full_name}/contents/${src}`,{method:'DELETE',body:JSON.stringify({message:`rm`,sha:item.sha,branch:State.curr.default_branch})});
                    }
                }
                Toast('Moved'); Repo.toggleSelect(); Repo.fetch();
            }
        };

        const Editor = {
            item: null,
            open: async (item) => {
                Editor.item=item; Nav.to('editor'); $('ed-name').textContent=item.path.split('/').pop(); $('ed-code').value='Loading...';
                try {
                    const d = await api(`/repos/${State.curr.full_name}/contents/${item.path}`);
                    Editor.item.sha = d.sha;
                    $('ed-code').value = decodeURIComponent(escape(window.atob(d.content.replace(/\n/g,""))));
                    Editor.gutter();
                } catch(e) { $('ed-code').value='Error'; }
            },
            new: () => {
                const n=$('new-name').value; if(!n)return; Modal.close(); Nav.to('editor');
                $('ed-name').textContent=n; $('ed-code').value=''; $('ed-msg').value='Create '+n;
                Editor.item={path:(State.path?State.path+'/':'')+n, isNew:true}; Editor.gutter();
            },
            save: async () => {
                try {
                    const c = window.btoa(unescape(encodeURIComponent($('ed-code').value)));
                    const b = {message:$('ed-msg').value||'Upd',content:c,branch:State.curr.default_branch};
                    if(!Editor.item.isNew) b.sha = Editor.item.sha;
                    const r = await api(`/repos/${State.curr.full_name}/contents/${Editor.item.path}`, {method:'PUT', body:JSON.stringify(b)});
                    Editor.item.sha = r.content.sha; Editor.item.isNew=false; Toast('Saved'); $('ed-msg').value='';
                } catch(e){}
            },
            gutter: () => $('ed-gutter').innerHTML = Array($('ed-code').value.split('\n').length).fill(0).map((_,i)=>i+1).join('\n')
        };
        
        $('ed-code').oninput=Editor.gutter; $('ed-code').onscroll=()=>$('ed-gutter').scrollTop=$('ed-code').scrollTop;
        $('file-input').onchange=e=>{State.files=Array.from(e.target.files);$('q-count').textContent=State.files.length;$('upload-q').classList.remove('hidden');};
        $('btn-login').onclick=App.login; $('search-input').onkeyup=e=>{if(e.key==='Enter')Repo.list()};

        App.init(); 
    </script>
</body>
</html>


