<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GitMobile v16</title>
    
    <link rel="icon" type="image/webp" href="https://files.catbox.moe/6kd6rm.webp">
    <link rel="apple-touch-icon" href="https://files.catbox.moe/6kd6rm.webp">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=block" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --bg: #0d1117; --panel: #161b22; --hover: #21262d; --border: #30363d;
            --primary: #238636; --ai: #8250df; --danger: #da3633; --text: #e6edf3; --muted: #7d8590;
            --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
            --header-h: 60px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font-ui); height: 100vh; overflow: hidden; user-select: none; }
        input, textarea, .selectable { user-select: text; }

        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }
        .w-full { width: 100%; }
        .text-sm { font-size: 14px; } .text-xs { font-size: 12px; }
        .font-bold { font-weight: 600; } .font-code { font-family: var(--font-code); }

        /* BUTTONS & LOADER */
        .btn {
            background: var(--panel); border: 1px solid var(--border); color: var(--text);
            padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 14px; transition: transform 0.1s; min-height: 40px; position: relative;
        }
        .btn:active { transform: scale(0.96); background: var(--hover); }
        .btn-primary { background: var(--primary); border-color: rgba(255,255,255,0.1); color: white; }
        .btn-ai { background: var(--ai); border-color: rgba(255,255,255,0.1); color: white; }
        .btn-danger { background: rgba(218,54,51,0.1); color: var(--danger); border-color: rgba(218,54,51,0.4); }
        .btn-icon { width: 44px; height: 44px; padding: 0; border-radius: 50%; }
        
        .loader {
            width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); 
            border-top-color: white; border-radius: 50%; 
            animation: spin 0.8s linear infinite; display: none;
            position: absolute; left: 50%; top: 50%; margin-left: -9px; margin-top: -9px;
        }
        .btn.loading .loader { display: block; }
        .btn.loading span, .btn.loading .icon, .btn.loading .btn-text { visibility: hidden; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .icon { font-family: 'Material Symbols Outlined'; font-size: 24px; display: inline-block; line-height: 1; }
        .icon-sm { font-size: 20px; } .icon-lg { font-size: 48px; }

        input, select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; }
        
        .view { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; opacity: 0; pointer-events: none; padding-bottom: env(safe-area-inset-bottom); transform: scale(0.98); transition: opacity 0.2s, transform 0.2s; }
        .view.active { opacity: 1; pointer-events: all; z-index: 10; transform: scale(1); }
        
        header { height: calc(var(--header-h) + env(safe-area-inset-top)); padding-top: env(safe-area-inset-top); background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding-left: 16px; padding-right: 16px; flex-shrink: 0; }
        .scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 16px; }

        .list-item { background: var(--panel); border: 1px solid var(--border); padding: 14px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; border-radius: 4px; }
        .list-item:active { background: var(--hover); }

        .chat-box { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px; border-radius: 12px; font-size: 14px; max-width: 85%; word-wrap: break-word; }
        .msg-u { align-self: flex-end; background: var(--primary); color: white; }
        .msg-a { align-self: flex-start; background: var(--panel); border: 1px solid var(--border); }
        .msg-s { align-self: center; font-size: 12px; color: var(--muted); }

        .editor-wrap { flex: 1; display: flex; background: #0d1117; font-family: var(--font-code); font-size: 13px; overflow: hidden; }
        .code-area { flex: 1; background: transparent; color: #e6edf3; border: none; padding: 16px; resize: none; white-space: pre; overflow: auto; tab-size: 2; width: 100%; height: 100%; }

        /* Tabs */
        .tab-btn { flex: 1; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--muted); border-radius: 0; }
        .tab-btn.active { border-bottom-color: var(--primary); color: white; }
        .tab-btn.active-ai { border-bottom-color: var(--ai); color: var(--ai); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal-box { background: var(--panel); border: 1px solid var(--border); width: 90%; max-width: 400px; padding: 24px; border-radius: 12px; display: flex; flex-direction: column; }

        #crash-screen { display:none; position:fixed; inset:0; background:black; z-index:99999; flex-direction:column; align-items:center; justify-content:center; padding:20px; text-align:center; }
        #toast-box { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; pointer-events: none; }
        .toast { background: var(--panel); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px black; }
    </style>
</head>
<body>

    <div id="crash-screen">
        <h2 style="color:var(--danger)">App Crashed</h2>
        <p class="text-muted" style="margin-bottom:20px" id="crash-msg">Unknown Error</p>
        <button class="btn btn-danger" onclick="localStorage.clear(); location.reload()">Factory Reset</button>
    </div>

    <div id="toast-box"></div>

    <!-- VIEW 1: LOGIN -->
    <div id="view-login" class="view active">
        <div style="margin: auto; width: 100%; max-width: 320px; text-align: center;">
            <span class="icon icon-lg" style="margin-bottom:20px">deployed_code</span>
            <h1 style="margin-bottom:30px">GitMobile</h1>
            <input type="password" id="gh-token" placeholder="GitHub Token" style="margin-bottom:20px">
            <button class="btn btn-primary w-full" id="btn-login" onclick="App.login()">
                <div class="loader"></div><span class="btn-text">Sign In</span>
            </button>
            <div style="margin-top:30px; border-top:1px solid var(--border); padding-top:20px">
                <p class="text-xs text-muted mb-2">AI API Key (Optional)</p>
                <input type="password" id="ai-key-login" placeholder="Gemini API Key">
            </div>
        </div>
    </div>

    <!-- VIEW 2: DASHBOARD -->
    <div id="view-dashboard" class="view">
        <header>
            <div class="flex gap-2">
                <img id="u-avatar" style="width:32px; height:32px; border-radius:50%; background:#333">
                <span id="u-login" class="font-bold">...</span>
            </div>
            <button class="btn btn-icon" onclick="Nav.to('settings')"><span class="icon">settings</span></button>
        </header>
        <div class="scroll">
            <div class="flex gap-2" style="margin-bottom:16px">
                <input id="search-input" placeholder="Search...">
                <select id="search-scope" style="width:auto"><option value="my">My Repos</option><option value="global">Global</option></select>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3 class="text-xs font-bold text-muted">REPOSITORIES</h3>
                <button class="btn btn-primary" style="padding: 6px 12px; font-size:12px;" onclick="Modal.open('create')">New</button>
            </div>
            <div id="repo-list"></div>
        </div>
    </div>

    <!-- VIEW 3: SETTINGS -->
    <div id="view-settings" class="view">
        <header>
            <button class="btn btn-icon" onclick="Nav.to('dashboard')"><span class="icon">arrow_back</span></button>
            <span class="font-bold">Settings</span>
            <div style="width:40px"></div>
        </header>
        <div class="scroll">
            <div style="background:var(--panel); padding:16px; border-radius:8px; border:1px solid var(--border); margin-bottom:20px">
                <label class="text-xs font-bold block mb-2">GEMINI API KEY</label>
                <input type="password" id="ai-key-set" placeholder="Paste key here">
                <button class="btn btn-primary w-full" style="margin-top:10px" onclick="App.saveAI()">Save Key</button>
            </div>
            <button class="btn btn-danger w-full" onclick="App.logout()">Logout</button>
        </div>
    </div>

    <!-- VIEW 4: REPO -->
    <div id="view-repo" class="view">
        <header>
            <button class="btn btn-icon" onclick="Nav.to('dashboard')"><span class="icon">arrow_back</span></button>
            <div style="text-align:center">
                <div id="r-name" class="font-bold">...</div>
                <div id="r-branch" class="text-xs text-muted font-code">main</div>
            </div>
            <div class="flex gap-2">
                <button id="btn-fork" class="btn hidden" onclick="Repo.fork()">
                    <div class="loader"></div><span class="btn-text">Fork</span>
                </button>
                <button id="btn-del" class="btn btn-icon btn-danger" onclick="Repo.delRepo()"><span class="icon">delete</span></button>
            </div>
        </header>
        <div class="flex" style="background:var(--panel); border-bottom:1px solid var(--border)">
            <button class="btn tab-btn active" onclick="Repo.tab('files')" id="tab-files">Files</button>
            <button class="btn tab-btn" onclick="Repo.tab('upload')" id="tab-upload">Upload</button>
            <button class="btn tab-btn" onclick="Repo.tab('ai')" id="tab-ai">AI Agent</button>
        </div>
        
        <!-- FILES TAB -->
        <div id="cont-files" class="flex-col" style="flex:1; overflow:hidden">
            <div class="flex" style="padding:12px; gap:10px; border-bottom:1px solid var(--border)">
                <button class="btn" style="font-size:12px; padding:6px 10px" onclick="Modal.open('newfile')"><span class="icon icon-sm">description</span> File</button>
                <button class="btn" style="font-size:12px; padding:6px 10px" onclick="Modal.open('newfolder')"><span class="icon icon-sm">create_new_folder</span> Folder</button>
                <button class="btn" style="font-size:12px; padding:6px 10px" onclick="Repo.fetch()"><span class="icon icon-sm">refresh</span></button>
            </div>
            <div class="flex" style="padding:12px; border-bottom:1px solid var(--border); overflow-x:auto; font-family:var(--font-code); font-size:12px;" id="crumbs"></div>
            <div id="file-list" class="scroll" style="padding:0"></div>
        </div>

        <!-- UPLOAD TAB -->
        <div id="cont-upload" class="scroll hidden">
            <div style="border:2px dashed var(--border); padding:40px; text-align:center; border-radius:8px; margin-top:20px; cursor:pointer;" onclick="$('file-input').click()">
                <span class="icon icon-lg" style="color:var(--muted)">cloud_upload</span>
                <h3>Select Folder</h3>
                <p class="text-muted text-sm">Target: <span id="upload-target" class="font-code">/</span></p>
                <input type="file" id="file-input" multiple webkitdirectory hidden>
            </div>
            <div id="upload-q" class="hidden" style="margin-top:20px">
                <p>Queue: <span id="q-count">0</span> files</p>
                <input id="up-msg" placeholder="Commit message" value="Bulk upload" style="margin:10px 0;">
                <button class="btn btn-primary w-full" id="btn-do-upload" onclick="Repo.executeUpload()">
                    <div class="loader"></div><span class="btn-text">Start Upload</span>
                </button>
                <div id="up-log" style="font-family:var(--font-code); font-size:11px; margin-top:10px; color:var(--muted);"></div>
            </div>
        </div>

        <!-- AI TAB -->
        <div id="cont-ai" class="flex-col hidden" style="flex:1; overflow:hidden">
            <div class="flex" style="padding:10px; border-bottom:1px solid var(--border); justify-content:space-between">
                <span class="text-xs font-bold text-muted">MEMORY ACTIVE</span>
                <button class="btn btn-icon" style="width:24px;height:24px;" onclick="AI.clear()" title="Reset Memory"><span class="icon icon-sm">delete_sweep</span></button>
            </div>
            <div id="chat-hist" class="chat-box">
                <div class="msg msg-a">I am Gemini. I remember our conversation and can edit this repo.</div>
            </div>
            <div style="padding:16px; background:var(--panel); border-top:1px solid var(--border); display:flex; gap:10px">
                <input id="ai-in" placeholder="E.g., 'Read src/index.js' or 'Fix the typo'">
                <button class="btn btn-ai btn-icon" onclick="AI.send()"><span class="icon">send</span></button>
            </div>
        </div>
    </div>

    <!-- VIEW 5: EDITOR -->
    <div id="view-editor" class="view" style="z-index:50">
        <header>
            <div class="flex gap-2">
                <button class="btn btn-icon" onclick="Nav.to('repo')"><span class="icon">close</span></button>
                <span id="ed-name" class="font-bold font-code">...</span>
            </div>
            <button class="btn btn-primary" id="btn-save" onclick="Editor.save()">
                <div class="loader"></div><span class="btn-text">Save</span>
            </button>
        </header>
        <div class="editor-wrap">
            <textarea class="code-area" id="ed-code" spellcheck="false" wrap="off"></textarea>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-top:0;">Title</h3>
            <div id="modal-body"></div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn" onclick="Modal.close()">Cancel</button>
                <button class="btn btn-primary" id="modal-ok">
                    <div class="loader"></div><span class="btn-text">Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // SAFETY
        window.onerror = (m) => { document.getElementById('crash-screen').style.display='flex'; document.getElementById('crash-msg').textContent=m; };
        const $ = id => document.getElementById(id);
        
        // STATE
        const State = {
            ghToken: localStorage.getItem('gm_gh'),
            aiToken: localStorage.getItem('gm_ai'),
            user: null, repos: [], curr: null, tree: [], path: '', files: [],
            chatHistory: [] // AI Memory
        };

        const Toast = (m, t='s') => {
            const el=document.createElement('div'); el.className='toast';
            el.innerHTML=`<span class="icon icon-sm" style="color:${t==='e'?'var(--danger)':'var(--primary)'}">${t==='e'?'error':'check'}</span><span>${m}</span>`;
            $('toast-box').appendChild(el);
            if(window.gsap) gsap.fromTo(el,{y:20,opacity:0},{y:0,opacity:1,duration:0.3});
            setTimeout(()=>el.remove(), 3000);
        };

        const Loader={
            on:id=>$(id).classList.add('loading'),
            off:id=>$(id).classList.remove('loading')
        };

        const Nav = {
            to: (id) => {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                $(`view-${id}`).classList.add('active');
            }
        };

        const API = {
            call: async (ep, method='GET', body=null) => {
                try {
                    const opt = { method, headers: {'Authorization': `token ${State.ghToken}`, 'Accept': 'application/vnd.github.v3+json'} };
                    if(body) opt.body = JSON.stringify(body);
                    const r = await fetch(ep.startsWith('http')?ep:`https://api.github.com${ep}`, opt);
                    if(r.status===401) { localStorage.clear(); location.reload(); throw new Error("Auth failed"); }
                    if(r.status===204) return null;
                    const d = await r.json();
                    if(!r.ok) throw new Error(d.message);
                    return d;
                } catch(e) { Toast(e.message, 'e'); throw e; }
            }
        };

        const App = {
            init: async () => {
                if(State.aiToken) $('ai-key-set').value = State.aiToken;
                if(State.ghToken) {
                    try {
                        State.user = await API.call('/user');
                        $('u-login').textContent = State.user.login; $('u-avatar').src = State.user.avatar_url;
                        Nav.to('dashboard'); Repo.list();
                    } catch(e) { Nav.to('login'); }
                }
            },
            login: async () => {
                const t = $('gh-token').value.trim();
                const k = $('ai-key-login').value.trim();
                if(!t) return;
                Loader.on('btn-login');
                State.ghToken = t; localStorage.setItem('gm_gh', t);
                if(k) { State.aiToken = k; localStorage.setItem('gm_ai', k); }
                try {
                    State.user = await API.call('/user');
                    $('u-login').textContent = State.user.login; $('u-avatar').src = State.user.avatar_url;
                    Nav.to('dashboard'); Repo.list();
                } catch(e) { State.ghToken=null; }
                finally { Loader.off('btn-login'); }
            },
            saveAI: () => {
                const k = $('ai-key-set').value.trim();
                localStorage.setItem('gm_ai', k); State.aiToken = k;
                Toast("AI Key Saved");
            },
            logout: () => { localStorage.clear(); location.reload(); }
        };

        const Repo = {
            list: async () => {
                const q = $('search-input').value;
                const el = $('repo-list'); el.innerHTML='<div style="padding:20px;text-align:center">Loading...</div>';
                try {
                    let d = [];
                    if($('search-scope').value==='my') {
                        d = (await API.call('/user/repos?sort=updated&per_page=30')).filter(r=>r.name.includes(q));
                    } else {
                        if(q.length<3) return el.innerHTML='<div style="padding:20px;text-align:center">Type 3+ chars</div>';
                        d = (await API.call(`/search/repositories?q=${q}`)).items;
                    }
                    el.innerHTML = d.map(r => `
                        <div class="list-item" onclick="Repo.open('${r.full_name}', '${r.default_branch}', '${r.owner.login}')">
                            <div><div style="color:#58a6ff;font-weight:600">${r.full_name}</div><div class="text-xs text-muted">${r.description||''}</div></div>
                            <span class="icon icon-sm" style="color:var(--muted)">chevron_right</span>
                        </div>
                    `).join('');
                } catch(e) { el.innerHTML='Error'; }
            },
            create: async () => {
                const n = $('new-repo-name').value;
                if(!n) return Toast('Name required', 'e');
                Loader.on('modal-ok');
                try {
                    await API.call('/user/repos', 'POST', { name: n, private: $('new-repo-private').checked, auto_init: true });
                    Toast('Created!'); Modal.close(); Repo.list();
                } catch(e) {} finally { Loader.off('modal-ok'); }
            },
            open: (n, b, owner) => {
                State.curr = { full_name: n, default_branch: b, owner: {login: owner} };
                $('r-name').textContent = n; $('r-branch').textContent = b;
                State.path = ''; State.chatHistory = []; 
                $('chat-hist').innerHTML = '<div class="msg msg-a">I am Gemini. Ready to help with this repo.</div>';
                
                const isMine = State.user.login === owner;
                $('btn-del').classList.toggle('hidden', !isMine);
                $('btn-fork').classList.toggle('hidden', isMine);
                
                Repo.tab('files'); Nav.to('repo'); Repo.fetch();
            },
            fetch: async () => {
                $('file-list').innerHTML='<div style="padding:20px">Loading...</div>';
                try {
                    const r = await API.call(`/repos/${State.curr.full_name}/git/trees/${State.curr.default_branch}?recursive=1`);
                    State.tree = r.tree; Repo.render();
                } catch(e) { $('file-list').innerHTML='Empty or Error'; State.tree = []; Repo.render(); }
            },
            render: () => {
                const el=$('file-list'); el.innerHTML='';
                const p = State.path;
                
                const bc=$('crumbs'); bc.innerHTML=`<span class="btn" style="padding:4px 8px;font-size:12px" onclick="Repo.nav('')">root</span>`;
                if(p) p.split('/').forEach((part,i,a) => bc.innerHTML+=`<span style="margin:0 4px">/</span><span class="btn" style="padding:4px 8px;font-size:12px" onclick="Repo.nav('${a.slice(0,i+1).join('/')}')">${part}</span>`);
                $('upload-target').textContent = p ? `/${p}` : '/';

                const items = State.tree.filter(i => {
                    if(p==='') return !i.path.includes('/');
                    return i.path.startsWith(p+'/') && i.path.split('/').length === p.split('/').length+1;
                }).sort((a,b) => (a.type===b.type)?0:(a.type==='tree'?-1:1));

                items.forEach(i => {
                    const row = document.createElement('div'); row.className='list-item';
                    const icon = i.type==='tree'?'folder':'description';
                    const col = i.type==='tree'?'#58a6ff':'var(--muted)';
                    row.innerHTML = `<div class="flex gap-2"><span class="icon icon-sm" style="color:${col}">${icon}</span><span class="font-code text-sm">${i.path.split('/').pop()}</span></div>`;
                    row.onclick = () => i.type==='tree' ? Repo.nav(i.path) : Editor.open(i);
                    el.appendChild(row);
                });
            },
            nav: p => { State.path=p; Repo.render(); },
            refresh: () => Repo.fetch(),
            tab: t => {
                $('cont-files').classList.toggle('hidden', t!=='files');
                $('cont-upload').classList.toggle('hidden', t!=='upload');
                $('cont-ai').classList.toggle('hidden', t!=='ai');
                $('tab-files').classList.toggle('active', t==='files');
                $('tab-upload').classList.toggle('active', t==='upload');
                $('tab-ai').classList.toggle('active-ai', t==='ai');
            },
            fork: async () => {
                if(!confirm(`Fork ${State.curr.full_name}?`)) return;
                Loader.on('btn-fork');
                try {
                    const r = await API.call(`/repos/${State.curr.full_name}/forks`, 'POST');
                    Toast('Fork started!'); setTimeout(() => { Repo.open(r.full_name, r.default_branch, State.user.login); }, 3000);
                } catch(e) {} finally { Loader.off('btn-fork'); }
            },
            delRepo: async () => {
                if(confirm(`DELETE ${State.curr.full_name}? This is permanent.`)) {
                    await API.call(`/repos/${State.curr.full_name}`, 'DELETE');
                    Nav.to('dashboard'); Repo.list(); Toast('Deleted');
                }
            },
            executeUpload: async () => {
                if(State.files.length===0) return Toast("No files selected", "e");
                Loader.on('btn-do-upload');
                const log = $('up-log'); log.innerHTML='Starting...';
                try {
                    for(let f of State.files) {
                        const rel = f.webkitRelativePath.split('/').slice(1).join('/'); 
                        const finalPath = (State.path ? State.path + '/' : '') + rel;
                        log.innerHTML += `<br>Up: ${finalPath}`;
                        const reader = new FileReader();
                        const b64 = await new Promise(r => { reader.onload = () => r(reader.result.split(',')[1]); reader.readAsDataURL(f); });
                        let sha; try{const ex=await API.call(`/repos/${State.curr.full_name}/contents/${finalPath}`); sha=ex.sha}catch(z){}
                        await API.call(`/repos/${State.curr.full_name}/contents/${finalPath}`, 'PUT', {
                            message: $('up-msg').value, content: b64, sha: sha, branch: State.curr.default_branch
                        });
                    }
                    Toast("Uploaded!"); Repo.tab('files'); Repo.fetch();
                } catch(e) { log.innerHTML+='<br>ERROR'; }
                finally { Loader.off('btn-do-upload'); }
            }
        };

        const Editor = {
            item: null,
            open: async (i) => {
                Editor.item=i; Nav.to('editor'); $('ed-name').textContent=i.path; $('ed-code').value='Loading...';
                try {
                    const d = await API.call(`/repos/${State.curr.full_name}/contents/${i.path}`);
                    Editor.item.sha = d.sha;
                    $('ed-code').value = decodeURIComponent(escape(window.atob(d.content.replace(/\n/g, ""))));
                } catch(e) { $('ed-code').value='Error'; }
            },
            initNew: () => {
                const n = $('new-name').value; if(!n) return;
                Modal.close(); Nav.to('editor');
                const p = (State.path ? State.path + '/' : '') + n;
                $('ed-name').textContent = p; $('ed-code').value = '';
                Editor.item = { path: p, isNew: true };
            },
            save: async () => {
                Loader.on('btn-save');
                try {
                    const b64 = window.btoa(unescape(encodeURIComponent($('ed-code').value)));
                    const body = { message: 'Update via GitMobile', content: b64, branch: State.curr.default_branch };
                    if(!Editor.item.isNew) body.sha = Editor.item.sha;
                    const r = await API.call(`/repos/${State.curr.full_name}/contents/${Editor.item.path}`, 'PUT', body);
                    Editor.item.sha = r.content.sha; Editor.item.isNew=false; Toast('Saved');
                } catch(e){} finally { Loader.off('btn-save'); }
            }
        };

        const AI = {
            clear: () => { State.chatHistory = []; $('chat-hist').innerHTML = '<div class="msg msg-a">Memory cleared.</div>'; },
            append: (t, type) => {
                const d = document.createElement('div'); d.className = `msg msg-${type}`; d.textContent = t;
                $('chat-hist').appendChild(d); $('chat-hist').scrollTop = $('chat-hist').scrollHeight;
                return d;
            },
            send: async () => {
                const txt = $('ai-in').value.trim(); if(!txt) return;
                if(!State.aiToken) return Toast("Set API Key in Settings", 'e');
                $('ai-in').value='';
                State.chatHistory.push({ role: 'user', parts: [{ text: txt }] });
                AI.append(txt, 'u'); const load = AI.append('Thinking...', 's');
                
                const prompt = `You are GitMobile Agent. Repo: ${State.curr.full_name}. Path: /${State.path}. 
                REPLY JSON ONLY: { "tool": "tool_name", ...args }
                Tools: read_file(path), update_file(path, content, message), create_file(path, content, message), delete_file(path, message), search(query), rename_repo(new_name), delete_repo(), reply(text)`;

                try {
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${State.aiToken}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ systemInstruction: { parts: [{ text: prompt }] }, contents: State.chatHistory })
                    });
                    const d = await r.json(); load.remove();
                    const aiTxt = d.candidates[0].content.parts[0].text;
                    State.chatHistory.push({ role: 'model', parts: [{ text: aiTxt }] });
                    AI.execute(JSON.parse(aiTxt.replace(/```json|```/g, '').trim()));
                } catch(e) { load.textContent="Error"; }
            },
            execute: async (cmd) => {
                const { tool, path, content, text, query, new_name } = cmd;
                try {
                    if(tool === 'reply') AI.append(text, 'a');
                    if(tool === 'read_file') {
                        const d = await API.call(`/repos/${State.curr.full_name}/contents/${path}`);
                        const c = decodeURIComponent(escape(window.atob(d.content.replace(/\n/g,""))));
                        State.chatHistory.push({ role: 'user', parts: [{ text: `FILE CONTENT:\n${c}` }] });
                        AI.append(`Read ${path}`, 'a');
                    }
                    if(tool === 'create_file' || tool === 'update_file') {
                        let sha; if(tool==='update_file') try{const f=await API.call(`/repos/${State.curr.full_name}/contents/${path}`); sha=f.sha}catch(e){}
                        await API.call(`/repos/${State.curr.full_name}/contents/${path}`, 'PUT', {message:'AI', content:window.btoa(unescape(encodeURIComponent(content))), sha});
                        AI.append(`Saved ${path}`, 'a'); Repo.fetch();
                    }
                    if(tool === 'delete_file') {
                        const f = await API.call(`/repos/${State.curr.full_name}/contents/${path}`);
                        await API.call(`/repos/${State.curr.full_name}/contents/${path}`, 'DELETE', {message:'AI Del', sha:f.sha});
                        AI.append(`Deleted ${path}`, 'a'); Repo.fetch();
                    }
                    if(tool === 'search') {
                        const res = await API.call(`/search/code?q=${encodeURIComponent(query)}+repo:${State.curr.full_name}`);
                        const hits = res.items.map(i=>i.path).join(', ');
                        State.chatHistory.push({ role: 'user', parts: [{ text: `RESULTS: ${hits}` }] });
                        AI.append(`Found in: ${hits}`, 'a');
                    }
                } catch(e) { AI.append("Tool fail: "+e.message, 's'); }
            }
        };

        const Modal = {
            open: (t) => {
                const b = $('modal-body'); $('modal-title').textContent=t; $('modal-overlay').classList.add('open');
                if(t==='create') { 
                    b.innerHTML='<label class="text-xs font-bold text-muted">Name</label><input id="new-repo-name" placeholder="Repo Name"><div style="margin-top:10px"><label><input type="checkbox" id="new-repo-private" checked> Private</label></div>'; 
                    $('modal-ok').onclick=Repo.create; 
                }
                if(t==='newfile') { 
                    b.innerHTML=`<p class="text-xs text-muted">In /${State.path}</p><input id="new-name" placeholder="Filename">`; 
                    $('modal-ok').onclick=Editor.initNew; 
                }
                if(t==='newfolder') { 
                    b.innerHTML=`<p class="text-xs text-muted">In /${State.path}</p><input id="new-fname" placeholder="Folder Name">`; 
                    $('modal-ok').onclick=Repo.newFolder; 
                }
            },
            close: () => $('modal-overlay').classList.remove('open')
        };

        // BINDINGS
        $('file-input').onchange=e=>{State.files=Array.from(e.target.files);$('q-count').textContent=State.files.length;$('upload-q').classList.remove('hidden');};
        $('btn-login').onclick=App.login; $('search-input').onkeyup=e=>{if(e.key==='Enter')Repo.list()};
        $('search-scope').onchange=Repo.list;

        App.init();
    </script>
</body>
</html>


